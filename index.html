<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recipe Image Resizer</title>
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #13151a;
      --muted: #9aa4b2;
      --text: #e8eef7;
      --accent: #4f46e5;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --border: #242834;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 10% -10%, #151a23, var(--bg));
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: grid;
      place-items: start center;
      padding: 32px 16px 64px;
    }
    .app {
      width: 100%;
      max-width: 980px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 28px;
      letter-spacing: -0.02em;
    }
    .sub { color: var(--muted); margin-bottom: 24px; }

    .upload {
      display: grid;
      gap: 16px;
    }

    .dropzone {
      border: 2px dashed #2b3240;
      border-radius: var(--radius);
      padding: 26px;
      display: grid;
      place-items: center;
      background: #0f1217;
      transition: border-color .2s ease, background .2s ease;
      cursor: pointer;
      text-align: center;
    }
    .dropzone.dragover { border-color: var(--accent); background: #101523; }
    .dropzone input { display: none; }
    .dz-title { font-weight: 600; }
    .dz-hint { color: var(--muted); font-size: 13px; }

    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }

    .btn {
      appearance: none; border: none; outline: none;
      background: var(--accent);
      color: white;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 600;
      letter-spacing: .2px;
      cursor: pointer;
      transition: transform .06s ease, opacity .2s ease, background .2s ease;
    }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background: #263046; color: #dbe4f3; }
    .btn.success { background: var(--accent-2); }
    .btn.text { background: transparent; color: var(--muted); }

    .helper { color: var(--muted); font-size: 14px; }
    .helper strong { color: #e6eaf2; }

    .panels { display: grid; gap: 16px; margin-top: 16px; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
    }

    .preview-wrap { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 780px) {
      .preview-wrap { grid-template-columns: 1fr 1fr; }
    }

    .card {
      background: #0f131a;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 10px;
    }
    .card h3 { margin: 0; font-size: 16px; }
    .meta { color: var(--muted); font-size: 12px; }
    .thumb {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: contain;
      background: #0c0f14;
      border-radius: 10px;
      border: 1px solid #1e2330;
    }

    .footer { color: var(--muted); font-size: 13px; margin-top: 18px; }
    .error { color: var(--danger); font-weight: 600; }
    .spacer { height: 8px; }
    .hide { display: none !important; }

    .progress { height: 4px; width: 100%; background: #0e1117; border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #09a1ff); transition: width .25s ease; }

    a.download-link { text-decoration: none; }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Recipe Image Resizer">
    <h1>Recipe Image Resizer</h1>
    <p class="sub">Upload a single landscape recipe image (PNG, JPG/JPEG, or WebP). Convert to JPG and create two widths: <strong>1600px</strong> (desktop) and <strong>700px</strong> (app). Everything runs in your browser; no uploads to a server.</p>

    <section class="upload panel" aria-label="Upload image">
      <label id="dropzone" class="dropzone" for="file">
        <input id="file" type="file" accept="image/png, image/jpeg, image/webp, image/jpg" aria-label="Choose image" />
        <div>
          <div class="dz-title">Click to choose an image</div>
          <div class="dz-hint">…or drag & drop it here</div>
        </div>
      </label>
      <div id="fileMeta" class="helper hide"></div>
    </section>

    <div class="spacer"></div>

    <section class="panel" aria-live="polite">
      <p id="instruction" class="helper">Create a desktop (<strong>1600px</strong> width) and app (<strong>700px</strong> width) version.</p>
      <div class="row">
        <button id="createBtn" class="btn" disabled>Create new versions</button>
        <button id="resetBtn" class="btn secondary" disabled>Reset</button>
      </div>
      <div class="row" style="gap:8px;margin-top:6px">
        <label class="helper" style="display:flex;align-items:center;gap:8px">
          <input id="optimize" type="checkbox" checked /> Optimize file size (adaptive quality)
        </label>
        <span class="helper" id="optimizeHint">Targets: ~500 KB (1600px), ~180 KB (700px)</span>
      </div>
      <div class="spacer"></div>
      <div id="progress" class="progress hide" aria-hidden="true"><div class="bar" id="bar"></div></div>
      <div id="status" class="helper" role="status"></div>
      <div id="error" class="error" role="alert"></div>
    </section>

    <section id="results" class="panels hide">
      <div class="panel">
        <h2 style="margin:0 0 8px;font-size:18px">Outputs</h2>
        <div class="preview-wrap">
          <div class="card">
            <h3>Desktop · 1600px</h3>
            <img id="img1600" class="thumb" alt="Preview 1600px" />
            <div class="meta" id="meta1600"></div>
            <div class="row">
              <a id="dl1600" class="btn download-link" download>Download 1600px JPG</a>
            </div>
          </div>
          <div class="card">
            <h3>App · 700px</h3>
            <img id="img700" class="thumb" alt="Preview 700px" />
            <div class="meta" id="meta700"></div>
            <div class="row">
              <a id="dl700" class="btn download-link" download>Download 700px JPG</a>
            </div>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button id="dlBoth" class="btn success" disabled>Download both</button>
          <button id="startOver" class="btn text">Start over</button>
        </div>
        <p class="footer">Filenames are based on your original, with <code>-desktop-1600.jpg</code> and <code>-app-700.jpg</code> suffixes.</p>
      </div>
    </section>

    <p class="footer">Tip: Host this single file as <code>index.html</code> on GitHub Pages and share the link with your team.</p>
  </div>

  <script>
    // --- DOM refs ---
    const fileInput = document.getElementById('file');
    const dropzone = document.getElementById('dropzone');
    const fileMeta = document.getElementById('fileMeta');
    const createBtn = document.getElementById('createBtn');
    const resetBtn = document.getElementById('resetBtn');
    const progress = document.getElementById('progress');
    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const optimizeChk = document.getElementById('optimize');
    const optimizeHint = document.getElementById('optimizeHint');

    const results = document.getElementById('results');
    const img1600 = document.getElementById('img1600');
    const img700 = document.getElementById('img700');
    const meta1600 = document.getElementById('meta1600');
    const meta700 = document.getElementById('meta700');
    const dl1600 = document.getElementById('dl1600');
    const dl700 = document.getElementById('dl700');
    const dlBoth = document.getElementById('dlBoth');
    const startOver = document.getElementById('startOver');

    // --- State ---
    let currentFile = null;
    let outputs = { 1600: null, 700: null }; // { blob, url, width, height, name }

    // --- Helpers ---
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmt = (n) => n.toLocaleString();
    function baseNameNoExt(filename) {
      const i = filename.lastIndexOf('.');
      return i === -1 ? filename : filename.slice(0, i);
    }

    function setProgress(p) {
      bar.style.width = `${Math.round(p)}%`;
    }

    function show(el) { el.classList.remove('hide'); }
    function hide(el) { el.classList.add('hide'); }

    function clearOutputs() {
      Object.values(outputs).forEach(o => { if (o && o.url) URL.revokeObjectURL(o.url); });
      outputs = { 1600: null, 700: null };
      img1600.src = img700.src = '';
      meta1600.textContent = meta700.textContent = '';
      dl1600.removeAttribute('href'); dl700.removeAttribute('href');
      dl1600.setAttribute('download', ''); dl700.setAttribute('download', '');
      dlBoth.disabled = true;
      hide(results);
    }

    function resetAll() {
      currentFile = null;
      fileInput.value = '';
      fileMeta.textContent = '';
      fileMeta.classList.add('hide');
      createBtn.disabled = true;
      resetBtn.disabled = true;
      statusEl.textContent = '';
      errorEl.textContent = '';
      clearOutputs();
    }

    function readableMime(file) {
      if (!file || !file.type) return 'Unknown';
      if (file.type === 'image/jpeg') return 'JPEG';
      if (file.type === 'image/png') return 'PNG';
      if (file.type === 'image/webp') return 'WebP';
      return file.type;
    }

    // Try to decode with orientation from EXIF using createImageBitmap when supported.
    async function decodeImageWithOrientation(file) {
      // Prefer createImageBitmap with EXIF orientation honored.
      try {
        if ('createImageBitmap' in window) {
          const bitmap = await createImageBitmap(file, { imageOrientation: 'from-image' });
          return { bmp: bitmap, width: bitmap.width, height: bitmap.height, release: () => bitmap.close && bitmap.close() };
        }
      } catch (e) {
        // Fallback below.
      }
      // Fallback: use HTMLImageElement (may ignore EXIF orientation on some browsers).
      const url = URL.createObjectURL(file);
      try {
        const img = await new Promise((resolve, reject) => {
          const i = new Image();
          i.onload = () => resolve(i);
          i.onerror = reject;
          i.src = url;
        });
        return { img, width: img.naturalWidth, height: img.naturalHeight, cleanupUrl: url };
      } catch (e) {
        URL.revokeObjectURL(url);
        throw e;
      }
    }

    function drawToCanvas(src, targetW, targetH) {
      const canvas = ('OffscreenCanvas' in window) ? new OffscreenCanvas(targetW, targetH) : Object.assign(document.createElement('canvas'), { width: targetW, height: targetH });
      if (!(canvas instanceof OffscreenCanvas)) {
        canvas.width = targetW; canvas.height = targetH;
      }
      const ctx = canvas.getContext('2d');
      // Better downscaling quality
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      if (src.bmp) {
        ctx.drawImage(src.bmp, 0, 0, targetW, targetH);
      } else if (src.img) {
        ctx.drawImage(src.img, 0, 0, targetW, targetH);
      } else {
        throw new Error('Unsupported source image.');
      }
      return canvas;
    }

    async function bytesToKB(bytes){ return Math.round(bytes / 1024); }

    async function canvasToJpegBlob(canvas, quality = 0.85) {
      if (canvas.convertToBlob) {
        return await canvas.convertToBlob({ type: 'image/jpeg', quality });
      }
      return await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
    }

    async function jpegWithAdaptiveQuality(canvas, width) {
      // Simple adaptive loop to keep sizes reasonable while preserving quality.
      // Targets chosen for landscape recipe images; tweak as needed.
      const targetKB = width >= 1600 ? 500 : 180; // approx size goals
      const qualities = [0.82, 0.74, 0.68, 0.62, 0.58];
      let chosen = qualities[0];
      let blob = await canvasToJpegBlob(canvas, chosen);
      for (let i = 0; i < qualities.length; i++) {
        chosen = qualities[i];
        blob = await canvasToJpegBlob(canvas, chosen);
        if (bytesToKB(blob.size) <= targetKB) break;
      }
      return { blob, quality: chosen, targetKB };
    }

    async function generateVersion(src, targetWidth, optimize = true) {(src, targetWidth) {
      const scale = targetWidth / src.width;
      const targetHeight = Math.max(1, Math.round(src.height * scale));
      const canvas = drawToCanvas(src, targetWidth, targetHeight);

      let blob, q = 0.9, targetKB = null;
      if (optimize) {
        const out = await jpegWithAdaptiveQuality(canvas, targetWidth);
        blob = out.blob; q = out.quality; targetKB = out.targetKB;
      } else {
        blob = await canvasToJpegBlob(canvas, q);
      }
      const url = URL.createObjectURL(blob);
      return { blob, url, width: targetWidth, height: targetHeight, quality: q, targetKB };
    }

    function enableCreateUI() {
      createBtn.disabled = false;
      resetBtn.disabled = false;
    }

    function updateFileMeta(file) {
      const kb = file.size / 1024;
      fileMeta.innerHTML = `<strong>Selected:</strong> ${file.name} · ${readableMime(file)} · ${fmt(Math.round(kb))} KB`;
      fileMeta.classList.remove('hide');
    }

    function setError(msg) {
      errorEl.textContent = msg;
    }

    // --- Event handlers ---
    dropzone.addEventListener('click', () => fileInput.click());

    ['dragenter', 'dragover'].forEach(evt => dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover');
    }));
    ['dragleave', 'drop'].forEach(evt => dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover');
    }));
    dropzone.addEventListener('drop', (e) => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) { handleFile(f); }
    });

    fileInput.addEventListener('change', () => {
      const f = fileInput.files && fileInput.files[0];
      if (f) { handleFile(f); }
    });

    async function handleFile(file) {
      setError('');
      clearOutputs();
      if (!file.type.startsWith('image/')) {
        setError('Please choose an image file (PNG, JPEG, or WebP).');
        return;
      }
      currentFile = file;
      updateFileMeta(file);
      enableCreateUI();
    }

    createBtn.addEventListener('click', async () => {
      if (!currentFile) return;
      try {
        createBtn.disabled = true; resetBtn.disabled = true;
        setError(''); statusEl.textContent = 'Decoding image…'; show(progress); setProgress(5);

        const src = await decodeImageWithOrientation(currentFile);
        setProgress(20); statusEl.textContent = `Source image: ${fmt(src.width)} × ${fmt(src.height)}px`;
        await sleep(150);

        // Generate 1600 then 700
        statusEl.textContent = 'Creating 1600px JPG…'; setProgress(55);
        const v1600 = await generateVersion(src, 1600, optimizeChk.checked);
        outputs[1600] = v1600;
        statusEl.textContent = 'Creating 700px JPG…'; setProgress(80);
        const v700 = await generateVersion(src, 700, optimizeChk.checked);
        outputs[700] = v700;

        // cleanup image object url if used
        if (src.cleanupUrl) URL.revokeObjectURL(src.cleanupUrl);
        if (src.release) src.release();

        // Wire UI
        const base = baseNameNoExt(currentFile.name) || 'image';
        const name1600 = `${base}-desktop-1600.jpg`;
        const name700 = `${base}-app-700.jpg`;

        img1600.src = v1600.url; meta1600.textContent = `${v1600.width} × ${v1600.height}px · JPG · ${bytesToKB(v1600.blob.size)} KB · q=${v1600.quality?.toFixed(2) ?? '0.90'}`;
        img700.src = v700.url;   meta700.textContent = `${v700.width} × ${v700.height}px · JPG · ${bytesToKB(v700.blob.size)} KB · q=${v700.quality?.toFixed(2) ?? '0.90'}`;

        dl1600.href = v1600.url; dl1600.download = name1600;
        dl700.href = v700.url;   dl700.download = name700;

        dlBoth.disabled = false;
        show(results);
        statusEl.textContent = 'Done! You can download your images below.'; setProgress(100);
      } catch (err) {
        console.error(err);
        setError('Failed to process image. The file may be corrupted or an unsupported format.');
        statusEl.textContent = '';
      } finally {
        hide(progress);
        createBtn.disabled = false; resetBtn.disabled = false;
        setTimeout(() => setProgress(0), 200);
      }
    });

    dlBoth.addEventListener('click', () => {
      // Trigger sequential downloads for both images
      if (outputs[1600] && outputs[700] && currentFile) {
        const base = baseNameNoExt(currentFile.name) || 'image';
        const name1600 = `${base}-desktop-1600.jpg`;
        const name700 = `${base}-app-700.jpg`;

        const a = document.createElement('a');
        a.style.display = 'none';
        document.body.appendChild(a);

        a.href = outputs[1600].url; a.download = name1600; a.click();
        setTimeout(() => { a.href = outputs[700].url; a.download = name700; a.click();
          setTimeout(() => document.body.removeChild(a), 50);
        }, 150);
      }
    });

    resetBtn.addEventListener('click', resetAll);
    startOver.addEventListener('click', resetAll);

    // Init
    resetAll();
  </script>
</body>
</html>
